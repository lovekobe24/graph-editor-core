<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>GraphEditor Sandbox</title>
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=1.0, minimum-scale=1.0, maximum-scale=1.0" />
  <style>
    body {
      margin: 0;
      width: 100vw;
      height: 100vh;
      user-select: none;
    }
  </style>
  <script
    src="https://at.alicdn.com/t/c/font_3759154_f4x5ab2inh5.js?spm=a313x.7781069.1998910419.53&file=font_3759154_f4x5ab2inh5.js"></script>
  <link rel="stylesheet"
    href="https://at.alicdn.com/t/c/font_3759154_f4x5ab2inh5.css?spm=a313x.7781069.1998910419.52&file=font_3759154_f4x5ab2inh5.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/9.10.2/jsoneditor.css"
    integrity="sha512-/JghmMAi5bleEgj1BT7h7Jm2+o4I4AbJYRVaY3eGGfdyTzV+yW3n0IedWH4ysbws5zpNK1beCqVJh0MSZxvNaA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- 引入 layui.css -->
  <link href="//unpkg.com/layui@2.8.3/dist/css/layui.css" rel="stylesheet">
  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/9.10.2/jsoneditor.min.js"
    integrity="sha512-jhDajNRbXZ4gJ8SVzcuWTHbgSX66Dh98CwmAkhBHWVuEYVgY8G35rbZuRlQwrOcwEB6z5aYzxUptsSjgTGlCbA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- <script src="../umd/GraphEditor.js"></script>
  <script src="../umd/GraphViewer.js"></script> -->
  <script src="../umd/Giraffe.js"></script>
  <!-- <script src="https://unpkg.com/graph-editor-core/umd/GraphEditor.js"></script> -->
  <!-- <script src="https://unpkg.com/graph-editor-core@1.0.25/umd/GraphViewer.js"></script> -->
  <script src="//unpkg.com/layui@2.8.3/dist/layui.js"></script>
</head>

<body oncontextmenu="return false;">
  <div style="padding: 0px 2px">

    <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" id="toRegularMode"><i
        class="iconfont icon-xuanze"></i></button>
    <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" id="save"><i
        class="iconfont icon-baocun"></i></button>
    <div class="layui-btn-group">
      <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" title="直线" id="line"><i
          class="iconfont icon-zhixian"></i></button>
      <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" title="连接线" id="connectedLine">连接线</button>
      <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" title="折线" id="polyline"><i
          class="iconfont icon-curve"></button>
      <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" title="钢笔" id="pen"><i
          class="iconfont icon-gangbi"></button>
      <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" title="图像" id="image"><i
          class="iconfont icon-image"></button>
    </div>
    <div class="layui-btn-group">
      <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" title="镜像" id="mirrorBtn"><i
          class="iconfont icon-jingxiang"></i></button>
    </div>
    <div class="layui-btn-group">
      <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" title="组合" id="group"><i
          class="iconfont icon-zuhe"></i></button>
      <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" title="取消组合" id="ungroup"><i
          class="iconfont icon-zuhe"></i></button>
    </div>
    <div class="layui-btn-group" id="alginToolbar">
      <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" title="左对齐" id="alignLeft"><i
          class="iconfont icon-shuipingzuoduiqi"></i></button>
      <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" title="右对齐" id="alignRight"><i
          class="iconfont icon-shuipingyouduiqi"></button>
      <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" title="顶对齐" id="alignTop"><i
          class="iconfont icon-chuizhidingduiqi"></button>
      <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" title="底对齐" id="alignBottom"><i
          class="iconfont icon-chuizhididuiqi"></button>
      <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" title="水平等距" id="horDis"><i
          class="iconfont icon-shuipingdengjufenbu"></button>
      <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" title="垂直等距" id="verDis"><i
          class="iconfont icon-chuizhidengjufenbu"></button>
    </div>
    <button id="showJson" class="layui-btn layui-btn-sm layui-btn-primary">显示JSON</button>
    <button id="clear" class="layui-btn layui-btn-sm layui-btn-primary">清空画布</button>
    <button title="预览" id="preview" class="layui-btn layui-btn-sm layui-btn-primary">预览</button>
    <button title="预设" id="styleConfig" class="layui-btn layui-btn-sm layui-btn-primary">预设线色</button>
    <button title="修改网格" id="gridConfig" class="layui-btn layui-btn-sm layui-btn-primary">修改网格</button>
    <button title="显示比例" id="zoom" class="layui-btn layui-btn-sm layui-btn-primary">150%</button>
    <button title="组成图元" id="makeSymbol" class="layui-btn layui-btn-sm layui-btn-primary">组成图元</button>
    <button title="编辑图元" id="editSymbol" class="layui-btn layui-btn-sm layui-btn-primary">编辑图元</button>
  </div>
  <div style="display: flex;">
    <div class="layui-tab" lay-filter="test-hash" style="border:1px solid gray;">
      <ul class="layui-tab-title">
        <li class="layui-this" lay-id="11">基本图形</li>
        <li lay-id="22">图元</li>
      </ul>
      <div class="layui-tab-content">
        <div class="layui-tab-item layui-show">
          <div id="leftPanel" style="border:1px solid gray;width: 260px;padding: 5px;display: flex;flex-wrap: wrap;">

          </div>
        </div>
        <div class="layui-tab-item">
          <div id="symbolPanel" style="border:1px solid gray;width: 260px;padding: 5px;display: flex;flex-wrap: wrap;">

          </div>
        </div>
      </div>
    </div>
    <!-- <div id="leftPanel"
      style="width:200px;min-width: 200px;display: flex;flex-wrap: wrap;align-items: flex-start;border:1px solid gray;padding: 5px;">
    </div> -->
    <div id="editor" style="background-color: bisque;border:1px solid gray;"></div>
    <div id="previewPanel" style="background-color: bisque;border:1px solid gray;"></div>
    <div class="layui-tab" lay-filter="test-hash" style="border:1px solid gray;">
      <ul class="layui-tab-title">
        <li class="layui-this" lay-id="11">属性</li>
        <li lay-id="22">动画</li>
        <li lay-id="22">变量</li>
      </ul>
      <div class="layui-tab-content">
        <div class="layui-tab-item layui-show">
          <div id="property" style="border:1px solid gray;width: 260px;padding: 5px;">
            <input>
          </div>
        </div>
        <div class="layui-tab-item">
          <div id="animationPanel" style="border:1px solid gray;width: 260px;padding: 5px;">
            <div class="layui-form-item">
              <label class="layui-form-label">类型</label>
              <div class="layui-input-block">
                <select id="animationType">
                  <option value="none">无</option>
                  <option value="rotateByCenter">旋转</option>
                  <option value="blink" selected>闪烁</option>
                  <option value="flow">流动</option>
                </select>
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">自动播放</label>
              <div class="layui-input-block">
                <input type="checkbox" name="open" lay-skin="switch" lay-filter="switchTest" title="ON|OFF"
                  id="autoPlayCheckBox">
              </div>
            </div>
          </div>
        </div>
        <div class="layui-tab-item">
          <div id="jsonEditor" style="width: 300px; height: 400px;"></div>
          <button id="addVarBtn">添加变量</button>
        </div>
      </div>
    </div>
  </div>
  <div id="menu" style="display: none;flex-direction: column;">

  </div>
  <!-- 定义一个上下文菜单 -->
  <div id="myContextMenu" style="display: none;position: absolute;background-color: gray;">
    <ul>
      <li ac="addVariable">添加变量</li>
      <li ac="editSymbol">编辑</li>
      <li ac="delSymbol">删除</li>
    </ul>
  </div>
  <div id="generateSymbolVaribles" style="display: flex;flex-direction: column;width: 400px;height: 500px;">
    <div>
      <label>名称</label>
      <input type="text" id="inputText">
    </div>

    <table id="variableTable" style="border: 1px solid black;">
      <thead>
        <tr>
          <th>变量名</th>
          <th>类型</th>

        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>


  <script type="module">
    import GraphEditor from '../src/GraphEditor';
    import GraphViewer from '../src/GraphViewer';
    import basicShapeList from "./shape/basic";
    import { Utils } from "../src/Utils"
    // import Giraffe from '../src/index.all'
    const container = document.getElementById("jsonEditor")
    const options = {}
    const editor = new JSONEditor(container, options)
    document.getElementById("editor").addEventListener('dragover', (event) => {
      event.preventDefault();
    })
    document.getElementById("editor").addEventListener('drop', (event) => {
      console.log("drop........");
      console.log(event.dataTransfer.getData("dropData"));
      if (event.dataTransfer.getData("dropData")) {
        let type = JSON.parse(event.dataTransfer.getData("dropData")).type;
        let shape = JSON.parse(event.dataTransfer.getData("dropData")).content
        if (type == 'shape') {
          graphEditor.dropShape(event, shape);
        } else {
          graphEditor.dropSymbol(event, shape);
        }

      }

    })


    //初始化左侧面板
    basicShapeList.forEach((shape) => {
      let shapeDiv = document.createElement("div");
      shapeDiv.style.width = "60px";
      shapeDiv.style.height = "60px";
      shapeDiv.style.display = "flex";
      shapeDiv.style.border = "1px solid grey";
      shapeDiv.style.margin = "2px";
      shapeDiv.style.flexDirection = "column";
      shapeDiv.setAttribute("draggable", true);
      shapeDiv.addEventListener('dragstart', (event) => {

        event.dataTransfer.setData(
          "dropData",
          JSON.stringify({ type: 'shape', content: shape })
        );
        // graphEditor.dropShape(event,shape);
      });

      let topDiv = document.createElement("div");
      topDiv.innerHTML = shape.path;
      let labelDiv = document.createElement("div");
      labelDiv.innerHTML = shape.label;
      shapeDiv.appendChild(topDiv);
      shapeDiv.appendChild(labelDiv);
      document.getElementById("leftPanel").appendChild(shapeDiv);
    })
    let curSymbol;
    let curSymbolIndex;
    myContextMenu.addEventListener('click', (e) => {
      console.log(e.target);
      let ac = $(e.target).attr('ac')
      let symbols = JSON.parse(localStorage.getItem('symbol'));
      if (ac == 'addVariable') {
        console.log('添加变量')
        if (curSymbol) {
          layer.open({
            type: 1,
            title: '输入内容',
            content: $("#generateSymbolVaribles"),
            btn: ['确认', '取消'],
            success: function (index, layero) {
              let tBody = $("#variableTable").find('tbody')[0];
              console.log(tBody);
            },
            yes: function (index, layero) {
              var inputValue = $('#inputText').val(); // 获取输入框的值
              // 处理输入框中的内容
              console.log("输入的内容是：" + inputValue);


              let symbolObj = graphEditor.addSymbolVariable(curSymbol, 'state', {
                type: 'integer',
                defaultVal: 1
              });
              if (symbolObj) {
                if (curSymbolIndex != -1) {
                  console.log('添加变量成功', curSymbolIndex)
                  symbols[curSymbolIndex] = symbolObj;
                  localStorage.setItem('symbol', JSON.stringify(symbols))
                } else {
                  console.log("未找到symbol")
                }

              }
              layer.close(index); // 关闭弹窗
            },
            btn2: function (index, layero) {
              // 点击取消按钮的回调函数
            }
          });
        }
        myContextMenu.style.display = 'none';
      } else if (ac == 'delSymbol') {
        if (curSymbolIndex != -1) {
          symbols.splice(curSymbolIndex, 1);
          localStorage.setItem('symbol', JSON.stringify(symbols))
          console.log('删除成功')
        } else {
          console.log("未找到要删除的symbol")
        }
      }
    })

    const initSymbolPanel = (symbols) => {
      symbols.forEach((symbol, index) => {
        let shapeDiv = document.createElement("div");
        shapeDiv.style.width = "60px";
        shapeDiv.style.height = "60px";
        shapeDiv.style.display = "flex";
        shapeDiv.style.border = "1px solid grey";
        shapeDiv.style.margin = "2px";
        shapeDiv.style.flexDirection = "column";
        shapeDiv.setAttribute("draggable", true);
        shapeDiv.addEventListener('dragstart', (event) => {

          event.dataTransfer.setData(
            "dropData",
            JSON.stringify({ type: 'symbol', content: symbol })
          );

        });
        // 显示上下文菜单
        shapeDiv.addEventListener('mousedown', function (e) {
          if (e.button === 2) {
            myContextMenu.style.display = 'block';
            myContextMenu.style.left = e.clientX + 'px';
            myContextMenu.style.top = e.clientY + 'px';
            curSymbol = symbol
            curSymbolIndex = index
          }
        });

        let topDiv = document.createElement("div");
        console.log(Giraffe);
        Giraffe.Utils.convertSymbolToImage(symbol, (img) => {
          console.log(img);
          img.style.width = '30px';
          img.style.height = '30px';
          topDiv.appendChild(img);
        })

        //  topDiv.innerHTML = shape.path;
        let labelDiv = document.createElement("div");
        labelDiv.innerHTML = symbol.symbolName;
        shapeDiv.appendChild(topDiv);
        shapeDiv.appendChild(labelDiv);
        document.getElementById("symbolPanel").appendChild(shapeDiv);
      })

    }

    let graphViewer;
    document.getElementById('toRegularMode').addEventListener('click', () => {
      graphEditor.stopDrawing();
    })
    let oldVariables;
    document.getElementById('editSymbol').addEventListener('click', () => {
      let selection = graphEditor.getSelection();
      console.log(selection)
      oldVariables = selection.variables
      graphEditor.editSymbol();
    })

    document.getElementById('line').addEventListener('click', () => {
      graphEditor.drawShape('line');
    })
    document.getElementById('polyline').addEventListener('click', () => {
      graphEditor.drawShape('polyline');
    })
    document.getElementById('pen').addEventListener('click', () => {
      graphEditor.drawShape('pen');
    })
    document.getElementById('connectedLine').addEventListener('click', () => {
      graphEditor.drawShape('straightConnectedLine');
    })


    document.getElementById('image').addEventListener('click', () => {
      graphEditor.insertImage();
    })
    document.getElementById('alignLeft').addEventListener('click', () => {
      graphEditor.align('left');
    })
    document.getElementById('alignRight').addEventListener('click', () => {
      graphEditor.align('right');
    })
    document.getElementById('alignTop').addEventListener('click', () => {
      graphEditor.align('top');
    })
    document.getElementById('alignBottom').addEventListener('click', () => {
      graphEditor.align('bottom');
    })
    document.getElementById('horDis').addEventListener('click', () => {
      graphEditor.align('horizontal');
    })
    document.getElementById('verDis').addEventListener('click', () => {
      graphEditor.align('vertical');
    })
    document.getElementById('save').addEventListener('click', () => {
      console.log('保存到localStorage');
      localStorage.setItem('graph', graphEditor.toJSON());

    })
    document.getElementById('preview').addEventListener('click', (e) => {
      preview(e.target)
    })
    document.getElementById('styleConfig').addEventListener('click', (e) => {
      graphEditor.setStyleConfig({
        'stroke': 'yellow',
        'hhsh': 'sdfsf'
      })
    })
    document.getElementById('gridConfig').addEventListener('click', (e) => {
      graphEditor.setGridConfig({
        'color': 'yellow'
      })
    })
    document.getElementById('zoom').addEventListener('click', (e) => {
      graphEditor.setScale(1.5)
    })
    document.getElementById('group').addEventListener('click', (e) => {
      graphEditor.group()
    })
    document.getElementById('ungroup').addEventListener('click', (e) => {
      graphEditor.unGroup()
    })
    document.getElementById('mirrorBtn').addEventListener('click', (e) => {
      let oldScaleX = graphEditor.getAttributeValue('scaleX');
      graphEditor.setAttributeValue('scaleX', -oldScaleX);
      console.log(oldScaleX);
    })
    document.getElementById('showJson').addEventListener('click', (e) => {
      console.log(graphEditor.checkId());
      console.log(JSON.parse(graphEditor.toJSON()))
    })

    document.getElementById('autoPlayCheckBox').addEventListener('click', (e) => {

      let checked = document.getElementById('autoPlayCheckBox').checked;
      if (checked) {
        graphEditor.setAnimationValue('autoPlay', true);
      } else {
        graphEditor.setAnimationValue('autoPlay', false);
      }
    })
    let localSymbol = localStorage.getItem('symbol');
    if (localSymbol) {
      let symbols = JSON.parse(localSymbol);
      initSymbolPanel(symbols);
    }

    $("#addVarBtn").on('click', () => {
      //给当前选中元素添加变量
      layer.open({
        type: 1,
        title: '输入内容',
        content: '<input type="text" id="varName">',
        btn: ['确认', '取消'],
        yes: function (index, layero) {
          var inputValue = $('#varName').val(); // 获取输入框的值
          // 处理输入框中的内容
          console.log("输入的内容是：" + inputValue);
          graphEditor.addVariable(inputValue, {
            'type': 'integer',
            'defaultVal': 0
          })
          layer.close(index); // 关闭弹窗
        },
        btn2: function (index, layero) {
          // 点击取消按钮的回调函数
        }
      });
    })
    document.getElementById('makeSymbol').addEventListener('click', (e) => {
      layer.open({
        type: 1,
        title: '输入内容',
        content: $("#generateSymbolVaribles"),
        btn: ['确认', '取消'],
        success: function (index, layero) {
          let tBody = $("#variableTable").find('tbody:first');
          let variables = graphEditor.extractVariables();
          console.log(variables);
          if (variables) {
            for (let key in variables) {
              let trDiv = document.createElement('tr');
              let tdDiv = document.createElement('td');
              trDiv.appendChild(tdDiv);
              tdDiv.style.textAlign = "center"
              tdDiv.innerHTML = key;
              tBody.append(trDiv);
              let hrDiv = document.createElement('hr');
              tBody.append(hrDiv);
            }
          }
        },
        yes: function (index, layero) {
          var inputValue = $('#inputText').val(); // 获取输入框的值
          // 处理输入框中的内容

          let symbolObj = graphEditor.makeSymbol(inputValue, oldVariables);
          console.log("组成的图元是：", symbolObj);
          if (symbolObj) {
            if (localSymbol) {
              let symbols = JSON.parse(localSymbol);
              let sameNameSymbol = symbols.filter((item) => item.symbolName == inputValue);
              //if(sameNameSymbol.length>0){

              symbols.push(JSON.parse(symbolObj));
              localStorage.setItem('symbol', JSON.stringify(symbols))
              //  }

            } else {
              let symbols = [];
              symbols.push(JSON.parse(symbolObj));
              localStorage.setItem('symbol', JSON.stringify(symbols))
            }
          }
          oldVariables = null;
          layer.close(index); // 关闭弹窗
        },
        btn2: function (index, layero) {
          // 点击取消按钮的回调函数
        }
      });



    })



    //动画面板
    document.getElementById('animationType').addEventListener('change', (e) => {
      console.log(e.target.value);
      let animationType = e.target.value;
      graphEditor.setAnimationValue('type', animationType);
    })
    document.getElementById("clear").addEventListener('click', () => {
      graphEditor.clear();
    })



    let tempDiv = document.createElement('div')
    tempDiv.setAttribute('id', 'temp')
    tempDiv.style.position = 'absolute'
    tempDiv.style.color = '#ffffff'
    tempDiv.style.padding = '10px'
    tempDiv.style.background = '#303133'
    document.getElementById("previewPanel").appendChild(tempDiv)





    const toRegularMode = () => {
      graphEditor.stopDrawing();
    }
    const draw = (shapeName) => {
      graphEditor.drawShape(shapeName);
    }
    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    let timer;
    const preview = (target) => {

      if (target.innerHTML == '预览') {
        let currentGraph = graphEditor.toJSON();

        let scale = graphEditor.getScale();
        graphEditor.destroy();
        graphView = new GraphViewer(
          {
            container: document.getElementById('editor'),
            graph: currentGraph,
          }
        );
        graphView.setScale(scale);
        graphView.init();

        //注册鼠标事件
        graphView.registerNodeMouseEvent({
          'mouseover': function (evt) {
            console.log('mouseover');
          },
          'mouseenter': function (evt, node, bound) {
            tempDiv.style.display = 'block';
            let top = bound.y + bound.height / 2;
            let left = bound.x + bound.width + 10;
            tempDiv.style.left = left + 'px';
            tempDiv.style.top = top + 'px';
            tempDiv.innerHTML = node.id;

          },
          'mouseleave': function (evt) {
            tempDiv.style.display = 'none';
          },
          'click tap': function (evt) {
            console.log('click');
          },
          'dblclick dbltap': function (evt) {
            console.log('dblclick');
          },
          'contextmenu': function (evt) {
            console.log('contextmenu');
          },
          'mousedown': function (evt) {
            console.log('mousedown');
          },
          'mouseup': function (evt) {
            console.log('mouseup');
          }
        })
        timer = setInterval(() => {
          let variableJson = {}
          let allNodes = graphView.getNodes();
          (function loop(nodes) {
            for (let node of nodes) {
              let className = node.className;
              let varJson = {};
              let variables = node.variables;
              for (let key in variables) {
                varJson[key] = getRandomInt(1, 3)
              }
              variableJson[node.id] = varJson;
              //图元将不再遍历
              if (className === 'GroupNode') {
                loop(node.members);
              }
            }
          })(allNodes);
          console.log(variableJson);
          //  graphView.setGraphVariable(variableJson);
          graphView.refreshGraph(variableJson);
        }, 5000)

        target.innerHTML = '退出预览'
      } else {
        clearInterval(timer);
        let currentGraph = graphView.config.graph;
        graphView.destroy();

        graphEditor = new GraphEditor(

          {
            container: document.getElementById('editor'),
            graph: currentGraph,
            drawing: {
              snapToGrid: {
                enable: true
              }
            }
          }
        );
        target.innerHTML = '预览'
      }

    }
    let existGraph = localStorage.getItem('graph');


    let graphEditor;
    const initGraphViewer = () => {
      console.log(existGraph);
      graphView = new GraphViewer(
        {
          container: document.getElementById('editor'),
          // graph: existGraph,
        }
      );
      graphView.setGraph(existGraph);
      graphView.setScale(1.2);
      graphView.refreshGraph()
    }
    const addSimpleNodeToEditor=()=>{
      graphEditor.addNode({
        className: 'RectNode',
        attributes: {
          x: 100,
          y: 300,
          width: 200,
          height: 60,
          strokeWidth: 2,
          stroke: 'red',
          scaleX:1.2,
          scaleY:1.2
        }
      })
      graphEditor.addNode({
        className: 'EllipseNode',
        attributes: {
          x: 200,
          y: 300,
          width: 100,
          height: 20,
          strokeWidth: 2,
          stroke: 'yellow'
        }
      })
      graphEditor.addNode({
        className: 'EllipseNode',
        attributes: {
          x: 40,
          y: 100,
          radiusX: 50,
          radiusY: 25,
          strokeWidth: 4,
          stroke: 'green'
        }
      })
      graphEditor.addNode({
        className: 'EllipseNode',
        attributes: {
          x: 200,
          y: 100,
          radiusX: 50,
          radiusY: 25,
          strokeWidth: 4,
          stroke: 'green',
          fill: 'green'
        }
      })
      graphEditor.addNode({
        className: 'CircleNode',
        attributes: {
          x: 300,
          y: 100,
          radius: 50,
          strokeWidth: 2,
          stroke: 'green',
          fill: 'green'
        }
      })

      graphEditor.addNode({
        className: 'TextNode',
        attributes: {
          x: 50,
          y: 50,
          align: 'left',
          padding: 10,
          fontFamily: "Arial",
          fontSize: 12,
          fontStyle: "normal",
          fontVariant: "normal",
          text: "中文",
          strokeWidth: 2,
          stroke: 'green',
          draggable: true
        }
      })
      // graphEditor.addNode({
      //   className: 'StarNode',
      //   attributes: {
      //     x: 50,
      //     y: 50,
      //     innerRadius: 20,
      //     outerRadius: 50,
      //     strokeWidth: 2,
      //     stroke: 'green',
      //     draggable: true
      //   }
      // })
      // graphEditor.addNode({
      //   className: 'ArcNode',
      //   attributes: {
      //     x: 152,
      //     y: 140,
      //     angle: 50,
      //     innerRadius: 20,
      //     outerRadius: 50,
      //     strokeWidth: 2,
      //     stroke: 'red',
      //     draggable: true
      //   }
      // })
      graphEditor.addNode(
        {
          className: 'PathNode',
          attributes: {
            x: 0,
            y: 0,
            data: 'M50,50 L200,100 C150,150 100,150 200,200',
            strokeWidth: 4,
            stroke: 'red',
            draggable: true,
            scaleX:1.2
          }
        })
      graphEditor.onModelChanged((sender, event) => {
        let nodes = event.getProperty('nodes');
        let eventName = event.getName();
        if (eventName == 'nodeAttributeChange') {
          console.log("节点的属性改变了", event.getProperty('nodes'));
        } else if (eventName == 'nodeEventsChange') {
          console.log("节点绑定的事件改变了", event.getProperty('events'));
        } else if (eventName == 'nodeVariableChange') {

          let type = event.getProperty('type');
          console.log("节点绑定的变量改变了", type);
          switch (type) {
            case 'add':
              break;
            case 'delete':
              break;
            case 'update':
              break;
          }
        } else if (eventName == 'nodeAnimationChange') {
          console.log("动画属性改变了", event.getProperty('animation'));
        } else if (eventName == 'modelVariableChange') {
          console.log("数据模型上绑定的变量发生编号", event.getProperty('variable'));
          let type = event.getProperty('type');
          switch (type) {
            case 'add':
              break;
            case 'delete':
              break;
            case 'update':
              break;
          }
        } else if (eventName == 'addNodes') {
          console.log("添加节点", event.getProperty('nodes'));
        } else if (eventName == 'removeNodes') {
          console.log("删除节点", event.getProperty('nodes'));
        } else if (eventName == 'nodePropertyChange') {
          console.log("节点的属性变化了", event.getProperty('tag'));
        }
      });

      let allNodes = graphEditor.getNodes();

      let ids = [];
      for (let node of allNodes) {
        ids.push(node.id);
      }
      // //复制，粘贴功能测试
      // graphEditor.copy(ids);
      // graphEditor.paste();
      // //撤销重做
      // graphEditor.undo();
      // graphEditor.redo();
      // //微调
      // graphEditor.move('up',100);
      // graphEditor.move('right',300);
      // graphEditor.move('down');
      // //对齐
      // graphEditor.align('top',ids);
      // graphEditor.align('top');

      // //调整显示比例
      graphEditor.setScale(1.2);

      graphEditor.setSize(500, 600);
      //设置背景色
      graphEditor.setBackgroundColor("#00ff00");

      // //添加变量
      graphEditor.addVariable('state', {
        type: 'integer',
        defaultVal: 3
      }, ids[0]);

      graphEditor.addVariable('变量3', {
        type: 'integer',
        defaultVal: 0
      }, ids[0]);
      console.log(graphEditor.getVariables(ids[0]));
      //修改变量
      graphEditor.updateVariable('变量3', {
        type: 'string',
        defaultVal: 6
      }, ids[0]);
      console.log(graphEditor.getVariables());
      console.log(graphEditor.getVariable('变量3', ids[0]));

      //  graphEditor.deleteVariable('变量2', false, ids[0]);

      // //设置属性
      graphEditor.setAttributeValues({
        'fill': 'red'
      }, ids[0]);
      // graphEditor.setAttributes({
      //   'rotation': 30
      // },ids);
      // graphEditor.setAttribute('fill','orange',ids);
      // graphEditor.group(ids);
      // let selectNodes=graphEditor.getSelection();
      // graphEditor.unGroup(selectNodes[0].id);
      // console.log('当前配置',graphEditor.getConfig());

      // //添加动画
      selectNodes = graphEditor.getSelection();


      graphEditor.getAnimation();
      let length = graphEditor.getNodes().length;
      // for (let i = 0; i <= 1; i++) {
      //   graphEditor.setAnimationValue('autoPlay', true, ids[i]);
      //   graphEditor.setAnimation({
      //     'type': 'rotateByCenter',
      //     'period': 2
      //   }, ids[i]);
      // }


      //graphEditor.setAnimationValue('type', 'none', ids[0]);

      // let groupArray = new Array(ids[2], ids[0]);

      // let groupNode=graphEditor.group(groupArray);
      // console.log(graphEditor.getNodes());
      // graphEditor.setAttributeValue('rotation',60, groupNode.id)

      // graphEditor.setAnimation({
      //     'type': 'rotateByCenter',
      //     'autoPlay':true,
      //     'period': 5
      //   }, groupNode.id);

      // graphEditor.setAnimation('type','rotateByCenter',selectNodes[0].id);
      // graphEditor.setAnimation('period',6,selectNodes[0].id);
      // console.log('获取画布上所有的节点',graphEditor.getNodes());
      // //设置背景色
      // graphEditor.setBackgroundColor('black');
      // // graphEditor.deleteNodes(selectNodes[0].id);
      //  //添加事件
      // graphEditor.addEvent({
      //   type: 'valueUpdate',
      //   action: 'changeProperty',
      //   value: [{
      //     name: 'fill', val: 'rgba(0,0,0,1)'
      //   }],
      //   where: {
      //     type: 'comparison',
      //     value: 1,
      //     key: "state",
      //     comparison: "="
      //   }
      // }, ids[0])
      // graphEditor.addEvent({
      //   type: 'click',
      //   action: 'executeScript',
      //   fnjs: 'console.log("world,balalabalabanabbl")'
      // }, ids[0])
      //单击更改属性
      graphEditor.addEvent({
        type: 'click',
        action: 'changeProperty',
        value: [{
          name: 'fill', val: 'rgba(255,255,0,1)'
        }],
      }, ids[0])
      // graphEditor.addEvent({
      //   type: 'valueUpdate',
      //   action: 'changeProperty',
      //   value: [{
      //     name: 'fill', val: 'rgba(255,0,0,1)'
      //   }],
      //   where: {
      //     type: 'comparison',
      //     value: 1,
      //     key: "state",
      //     comparison: "!="
      //   }
      // }, ids[0])
      // graphEditor.addEvent({
      //   type: 'valueUpdate',
      //   action: 'executeScript',
      //   fnjs: "switch(data.state){\r\n    case 1:\r\n    viewer.setNodeAttribute(node,'fill','#C80000')\r\n    break;\r\n    case 2:\r\n      viewer.setNodeAttribute(node,'fill','#FFFF2B')\r\n    break;\r\n    default:\r\n     viewer.setNodeAttribute(node,'fill','#000000')\r\n}"
      // },ids[0]);
      graphEditor.order('top');
      // graphEditor.getDataModel().getSelectionManager().setSelection( ids[2], true);
      //点击启动动画
      // graphEditor.addEvent({
      //   type: 'click',
      //   action: 'executeAnimation'
      // }, ids[0])
      // //更新事件
      // graphEditor.updateEvent({type:'click'}, 0, selectNodes[0].id)
      // //添加属性
      // graphEditor.savePropertyInEvent({'stroke':'green'}, -1, 0, selectNodes[0].id)
      // //删除属性
      // graphEditor.deletePropertyInEvent(0, 0, selectNodes[0].id);
      // //删除事件
      //graphEditor.deleteEvent(0,selectNodes[0].id);

      // let json = graphEditor.toJSON();

    }
    const initGraphEditor = () => {
      graphEditor = new GraphEditor(
        {
          container: document.getElementById('editor'),
            graph: existGraph,
          view: {
            transformer: {
              anchorSize: 6
            },
            editAnchor: {
              anchorFill: 'white',
              anchorStroke: 'rgb(0, 161, 255)'
            }
          },
          drawing: {
            snapToGrid: {
              enable: true,
            }
          },
          selection: {
            keyboard: {
              map: {
                moveLeft: ['Shift+ArrowLeft'],
                moveRight: ['Shift+ArrowRight'],
                moveUp: ['Shift+ArrowUp'],
                moveDown: ['Shift+ArrowDown']
              }
            }
          }
        }
      );
      //创建监听
      graphEditor.onSelectionChanged((sender, event) => {
        let selectedNodes = event.getProperty('nodes');
        console.log("onSelectionChanged", selectedNodes);
      })
      var menuNode = document.getElementById('menu');
      let map = graphEditor.getFnMap();
      createMenu(map);
      graphEditor.registerContextMenu((e) => {
        // alert("ok")
        let fnState = graphEditor.getFnState();
        const buttons = menuNode.getElementsByTagName('button');

        for (let i = 0; i < buttons.length; i++) {

          let innerHTML = buttons[i].innerHTML;
          console.log(fnState.has(innerHTML));
          if (fnState.has(innerHTML)) {
            let state = fnState.get(innerHTML);
            if (state) {
              buttons[i].removeAttribute('disabled');
            } else {
              buttons[i].setAttribute('disabled', true);
            }
          }
        }
        menuNode.style.border = "1px solid red";
        menuNode.style.display = 'flex';
        menuNode.style.left = e.clientX + "px";
        menuNode.style.top = e.clientY + "px";
        menuNode.style.position = "absolute";
      })
      function createMenu(map) {
        menuNode.innerHTML = '';
        map.forEach((value, key) => {

          let divElement = document.createElement('button');
          divElement.innerHTML = key;
          divElement.addEventListener('click', () => {
            value();
            menuNode.style.display = 'none';
          })
          menuNode.append(divElement);
        });


      }

      //addSimpleNodeToEditor();
     
      graphEditor.onSelectionChanged((sender, event) => {
        menuNode.style.display = 'none';
        let selectedNodes = event.getProperty('nodes');

        if (selectedNodes.length > 0) {
          initPropertyPanel(selectedNodes[0])
          if (selectedNodes.length == 1) {
            initAnimationPanel(selectedNodes[0])
            initVariablePanel(selectedNodes[0])
          }

        }
        //进行相应操作
      });

    }


    const getColorDiv = (proName, value) => {
      let compDiv = document.createElement('div');
      compDiv.style.display = 'flex';
      compDiv.style.padding = '5px';
      let strokeLabel = document.createElement('div');
      strokeLabel.innerHTML = proName;
      strokeLabel.style.marginRight = '4px';
      let attrDiv = document.createElement('input')

      attrDiv.setAttribute('type', 'color');
      attrDiv.value = value;
      compDiv.appendChild(strokeLabel);
      compDiv.appendChild(attrDiv);
      attrDiv.addEventListener('change', (evt) => {
        let strokeColor = attrDiv.value;

        graphEditor.setAttributeValue(proName, strokeColor);
      })
      return compDiv;
    }
    const getNumberDiv = (proName, value) => {
      let compDiv = document.createElement('div');
      compDiv.style.display = 'flex';
      compDiv.style.padding = '5px';
      let strokeLabel = document.createElement('div');
      strokeLabel.innerHTML = proName;
      strokeLabel.style.marginRight = '4px';
      let attrDiv = document.createElement('input')
      attrDiv.value = value;
      compDiv.appendChild(strokeLabel);
      compDiv.appendChild(attrDiv);
      attrDiv.addEventListener('change', (evt) => {
        graphEditor.setAttributeValue(proName, parseFloat(attrDiv.value));
      })
      return compDiv;
    }
    const getStrDiv = (proName, value) => {
      let compDiv = document.createElement('div');
      compDiv.style.display = 'flex';
      compDiv.style.padding = '5px';
      let strokeLabel = document.createElement('div');
      strokeLabel.innerHTML = proName;
      strokeLabel.style.marginRight = '4px';
      let attrDiv = document.createElement('textArea')
      attrDiv.value = value;
      compDiv.appendChild(strokeLabel);
      compDiv.appendChild(attrDiv);
      return compDiv;

    }
    const initPropertyPanel = (node) => {


      document.getElementById('property').innerHTML = '';
      let idDiv = getStrDiv('id', node.id);
      document.getElementById('property').appendChild(idDiv);
      for (let key in node.attributes) {

        switch (key) {
          case 'fill':
          case 'stroke':
            let compDiv = getColorDiv(key, node.attributes[key]);
            document.getElementById('property').appendChild(compDiv);

            break;
          case 'width':
          case 'height':
          case 'radiusX':
          case 'radiusY':
          case 'strokeWidth':
          case 'scaleX':
          case 'scaleY':
          case 'x':
          case 'y':
          case 'rotation':
            let numberDiv = getNumberDiv(key, node.attributes[key]);
            document.getElementById('property').appendChild(numberDiv);
            break;
        }

      }
    }
    const initVariablePanel = (node) => {
      let variables = node.variables;
      if (variables) {
        editor.set(variables)
      }

    }
    const initAnimationPanel = (node) => {

      let autoPlay = node.animation['autoPlay'];
      let checkboxObj = document.getElementById('autoPlayCheckBox')
      if (autoPlay) {
        var checked = document.createAttribute("checked");
        checked.nodeValue = "checked"
        // 为dom对象加入属性
        checkboxObj.attributes.setNamedItem(checked)
      } else {
        document.getElementById('autoPlayCheckBox').value = false
      }
    }
    initGraphEditor()
   //initGraphViewer()
  </script>
</body>

</html>